<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<title>FHIR Trees — Elements & Resources</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>

<style>
    body {
        font-family: Inter, sans-serif;
        margin: 0;
        background: #f4f6f9;
        overflow: hidden;
    }

    /* ---------------- TAB ---------------- */
    .tabs {
        display: flex;
        background: #2d3748;
        padding: 10px;
        height: 50px;
        box-sizing: border-box;
    }
    .tab {
        color: white;
        padding: 10px 25px;
        cursor: pointer;
        font-size: 16px;
        border-right: 1px solid #4a5568;
        user-select: none;
    }
    .tab.active {
        background: #4a5568;
        font-weight: bold;
    }

    /* ---------------- VIEW BUTTONS ---------------- */
    .view-switch {
        position: absolute;
        top: 50px;
        left: 0;
        padding: 8px;
        z-index: 10;
        display: flex;
        gap: 8px;
        background: rgba(255,255,255,0.9);
    }
    .view-switch button {
        padding: 6px 18px;
        border-radius: 6px;
        border: none;
        background: #2b6cb0;
        color: white;
        cursor: pointer;
        font-size: 14px;
    }

    /* GRAPH AREA */
    #treeContainer {
        position: absolute;
        top: 90px;
        left: 0;
        width: calc(100% - 300px);
        bottom: 0;
        overflow: hidden;
    }
    svg {
        width: 100%;
        height: 100%;
        cursor: grab;
    }

    /* FHIR DETAIL PANEL */
    #detailsPanel {
        position: absolute;
        top: 90px;
        right: 0;
        width: 300px;
        bottom: 0;
        background: white;
        border-left: 1px solid #cbd5e0;
        overflow-y: auto;
        padding: 16px;
        font-size: 14px;
    }
    #detailsPanel h2 {
        margin-top: 0;
    }

    /* NODE STYLE */
    .node rect {
        stroke-width: 1.6px;
        rx: 8;
        ry: 8;
        stroke: #4A5568;
        fill: #f8f9fa;
    }

    /* LINK STYLE - MIGLIORATO */
    .link {
        fill: none;
        stroke: #718096;
        stroke-width: 2px;
        stroke-opacity: 0.8;
    }

    /* minimap */
    #minimap {
        position: absolute;
        width: 200px;
        height: 150px;
        bottom: 20px;
        right: 20px;
        background: rgba(255,255,255,0.8);
        border: 1px solid #a0aec0;
        overflow: hidden;
        z-index: 50;
    }
    #minimap svg {
        width: 200px;
        height: 150px;
    }
</style>
</head>

<body>

<div class="tabs">
    <div class="tab active" data-tree="elements">Elements Tree</div>
    <div class="tab" data-tree="resources">Resources Tree</div>
</div>

<div id="treeContainer">
    <svg id="treeSVG"></svg>tree
</div>

<div id="detailsPanel">
    <h2>FHIR Node Details</h2>
    <div id="detailsContent">Select a node...</div>
</div>

<div id="minimap">
    <svg id="minimapSVG"></svg>
</div>
<script>
/* ============================================================
   SETUP INIZIALE D3
============================================================ */
const svg = d3.select("#treeSVG");
const g = svg.append("g");

const minimapSvg = d3.select("#minimapSVG");
const miniG = minimapSvg.append("g");

function getSize() {
    return {
        width: document.getElementById("treeContainer").clientWidth,
        height: document.getElementById("treeContainer").clientHeight
    };
}

let { width, height } = getSize();

const zoom = d3.zoom()
    .scaleExtent([0.3, 2])
    .on("zoom", e => {
        g.attr("transform", e.transform);
    });

svg.call(zoom);

window.addEventListener("resize", () => {
    const s = getSize();
    width = s.width;
    height = s.height;
    svg.attr("width", width).attr("height", height);
});


const treeLayout = d3.tree()
    .nodeSize([70, 260])
    .separation((a, b) => a.parent === b.parent ? 1 : 1.8);

let currentRoot = null;
let simulation = null;

function getNodeTypeClass(d) {
    return "node";
}

function escapeHtml(str) {
    return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
}

/* ============================================================
   DETTAGLIO FHIR NEL PANNELLO A DESTRA
============================================================ */
function showDetails(d) {
    const data = d.data || {};
    const panel = document.getElementById("detailsContent");

    let html = "";

    html += `<strong>Name:</strong> ${data.name || "-"}<br/>`;
    if (data.title) {
        html += `<strong>Description:</strong> ${data.title}<br/>`;
    }
    if (data.children.length > 0){
        html += `<hr/><strong>Children:</strong><br/>`;
        for(const child of data.children){
            html += `${child.name}<br/>`
        }
    }

    panel.innerHTML = html;

    // highlight del nodo selezionato
    g.selectAll("g.node").classed("selected", false);
    if (d.subjectGroup) {
        d3.select(d.subjectGroup).classed("selected", true);
    }
}

/* ============================================================
   CARICAMENTO ALBERO DA JSON
============================================================ */
function loadTree(jsonFile) {
    d3.json(jsonFile).then(data => {
        const root = d3.hierarchy(data);
        currentRoot = root;
        root.x0 = 0;
        root.y0 = 0;

        if (root.children) root.children.forEach(collapse);
        update(root, true);
    });
}

/* ============================================================
   COLLAPSE / TOGGLE
============================================================ */
function collapse(d) {
    if (d.children) {
        d._children = d.children;
        d._children.forEach(collapse);
        d.children = null;
    }
}

function toggle(d) {
    if (d.children) {
        d._children = d.children;
        d.children = null;
    } else {
        d.children = d._children;
        d._children = null;
    }
}

function update(root, initial = false) {

    // stop eventuale simulazione force
    if (simulation) {
        simulation.stop();
        simulation = null;
    }

    treeLayout(root);

    const nodes = root.descendants();
    const links = root.links();

    // centratura iniziale
    if (initial) {
        const minX = d3.min(nodes, d => d.x);
        const maxX = d3.max(nodes, d => d.x);
        const treeHeight = maxX - minX || 1;

        svg.call(
            zoom.transform,
            d3.zoomIdentity
                .translate(120, height / 2 - treeHeight / 2)
                .scale(0.9)
        );
    }

    // -------- NODI --------
    const node = g.selectAll("g.node")
        .data(nodes, d => d.id || (d.id = d.data.name + "_" + d.depth));

    const nodeEnter = node.enter()
        .append("g")
        .attr("class", "node")
        .attr("transform", `translate(${root.y0},${root.x0})`)
        .each(function(d){ d.subjectGroup = this; })
        .on("click", (event, d) => {
            event.stopPropagation();
            showDetails(d);
            toggle(d);
            update(root);
        });

    nodeEnter.append("rect")
        .attr("width", 240)
        .attr("height", 40)
        .attr("x", -20)
        .attr("y", -20);

    nodeEnter.append("text")
        .attr("x", 110)
        .attr("dy", 5)
        .attr("text-anchor", "middle")
        .text(d => d.data.name);

    nodeEnter.append("text")
        .attr("class", "toggle-icon")
        .attr("x", -10)
        .attr("y", -23)
        .text(d => d._children ? "+" : d.children ? "−" : "");

    const nodeUpdate = nodeEnter.merge(node);

    nodeUpdate.transition().duration(350)
        .attr("transform", d => `translate(${d.y},${d.x})`);

    nodeUpdate.select(".toggle-icon")
        .text(d => d._children ? "+" : d.children ? "−" : "");

    node.exit().remove();

    // -------- LINK --------
    const link = g.selectAll("path.link")
        .data(links, d => d.target.id);

    const linkEnter = link.enter()
        .insert("path", "g")
        .attr("class", "link")
        .attr("d", () => curve(root, root));

    linkEnter.merge(link)
        .transition().duration(350)
        .attr("d", d => curve(d.source, d.target));

    link.exit().remove();

    // update minimap
    updateMinimap(nodes, links);
}

function curve(s, t) {
    return `M${s.y},${s.x}
            C${(s.y + t.y)/2},${s.x}
             ${(s.y + t.y)/2},${t.x}
             ${t.y},${t.x}`;
}

function activateTreeView() {
    if (currentRoot) {
        update(currentRoot, false);
    }
}

function updateMinimap(nodes, links) {
    if (!nodes || !nodes.length) return;

    const miniWidth = 200;
    const miniHeight = 150;

    const minX = d3.min(nodes, d => d.x);
    const maxX = d3.max(nodes, d => d.x);
    const minY = d3.min(nodes, d => d.y);
    const maxY = d3.max(nodes, d => d.y);

    const dx = maxY - minY || 1;
    const dy = maxX - minX || 1;

    const scale = 0.8 * Math.min(miniWidth / dx, miniHeight / dy);

    const offsetX = (minY + maxY) / 2;
    const offsetY = (minX + maxX) / 2;

    // link nella minimap
    const miniLinks = miniG.selectAll("line.mini-link")
        .data(links, d => d.target.id);

    miniLinks.enter()
        .append("line")
        .attr("class", "mini-link")
        .merge(miniLinks)
        .attr("x1", d => (d.source.y - offsetX) * scale + miniWidth / 2)
        .attr("y1", d => (d.source.x - offsetY) * scale + miniHeight / 2)
        .attr("x2", d => (d.target.y - offsetX) * scale + miniWidth / 2)
        .attr("y2", d => (d.target.x - offsetY) * scale + miniHeight / 2)
        .attr("stroke", "#a0aec0")
        .attr("stroke-width", 1);

    miniLinks.exit().remove();

    // nodi nella minimap
    const miniNodes = miniG.selectAll("circle.mini-node")
        .data(nodes, d => d.id);

    miniNodes.enter()
        .append("circle")
        .attr("class", "mini-node")
        .attr("r", 2.5)
        .merge(miniNodes)
        .attr("cx", d => (d.y - offsetX) * scale + miniWidth / 2)
        .attr("cy", d => (d.x - offsetY) * scale + miniHeight / 2)
        .attr("fill", "#4a5568");

    miniNodes.exit().remove();
}

document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");

        g.selectAll("*").remove();
        miniG.selectAll("*").remove();
        document.getElementById("detailsContent").innerHTML = "Select a node...";

        const file = tab.getAttribute("data-tree") === "elements"
            ? "elements_tree.json"
            : "resources_tree.json";

        loadTree(file);
    });
});

/* ============================================================
   LOAD DEFAULT
============================================================ */
loadTree("elements_tree.json");

</script>
</body>
</html>